<!-- templates/admin/edit_course.html -->
{% extends "base.html" %}

{% block title %}Edit Course - Admin Panel{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb -->
    <nav class="flex mb-8" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-4">
            <li>
                <a href="{{ url_for('admin_dashboard') }}" class="text-gray-400 hover:text-gray-500">
                    <i class="fas fa-home"></i>
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mr-4"></i>
                    <a href="{{ url_for('admin_courses') }}" class="text-gray-400 hover:text-gray-500">Courses</a>
                </div>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mr-4"></i>
                    <span class="text-gray-500">Edit Course</span>
                </div>
            </li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Edit Course: {{ course.title }}</h1>
        <p class="mt-2 text-gray-600">Update course information and settings</p>
    </div>

    <!-- Course Edit Form -->
    <form method="POST" action="{{ url_for('admin_edit_course_submit', course_id=course._id) }}" class="space-y-8">
        <!-- Basic Information -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">Basic Information</h2>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700">Course Title *</label>
                    <input type="text" name="title" id="title" required value="{{ course.title }}"
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm"
                           placeholder="Enter course title">
                    <p class="mt-1 text-sm text-gray-500">Choose a clear, descriptive title for the course</p>
                </div>

                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Description *</label>
                    <textarea name="description" id="description" rows="4" required
                              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm"
                              placeholder="Describe what students will learn in this course">{{ course.description }}</textarea>
                    <p class="mt-1 text-sm text-gray-500">Provide a comprehensive overview of the course content</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="instructor_id" class="block text-sm font-medium text-gray-700">Instructor *</label>
                        <select name="instructor_id" id="instructor_id" required
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm">
                            <option value="">Select Instructor</option>
                            {% for educator in educators %}
                            <option value="{{ educator._id }}" {{ 'selected' if educator._id == course.instructor_id }}>
                                {{ educator.name }} ({{ educator.email }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label for="level" class="block text-sm font-medium text-gray-700">Level *</label>
                        <select name="level" id="level" required
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm">
                            <option value="">Select Level</option>
                            <option value="Beginner" {{ 'selected' if course.level == 'Beginner' }}>Beginner</option>
                            <option value="Intermediate" {{ 'selected' if course.level == 'Intermediate' }}>Intermediate</option>
                            <option value="Advanced" {{ 'selected' if course.level == 'Advanced' }}>Advanced</option>
                        </select>
                    </div>

                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                        <select name="category" id="category"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm">
                            <option value="">Select Category</option>
                            <option value="Grammar" {{ 'selected' if course.category == 'Grammar' }}>Grammar</option>
                            <option value="Vocabulary" {{ 'selected' if course.category == 'Vocabulary' }}>Vocabulary</option>
                            <option value="Speaking" {{ 'selected' if course.category == 'Speaking' }}>Speaking</option>
                            <option value="Writing" {{ 'selected' if course.category == 'Writing' }}>Writing</option>
                            <option value="Reading" {{ 'selected' if course.category == 'Reading' }}>Reading</option>
                            <option value="Listening" {{ 'selected' if course.category == 'Listening' }}>Listening</option>
                            <option value="Business English" {{ 'selected' if course.category == 'Business English' }}>Business English</option>
                            <option value="Test Preparation" {{ 'selected' if course.category == 'Test Preparation' }}>Test Preparation</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="duration" class="block text-sm font-medium text-gray-700">Duration</label>
                        <input type="text" name="duration" id="duration" value="{{ course.duration or '' }}"
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm"
                               placeholder="e.g., 8 weeks, 12 hours">
                        <p class="mt-1 text-sm text-gray-500">Estimated time to complete the course</p>
                    </div>

                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                        <select name="status" id="status"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm">
                            <option value="draft" {{ 'selected' if course.status == 'draft' }}>Draft</option>
                            <option value="published" {{ 'selected' if course.status == 'published' }}>Published</option>
                            <option value="archived" {{ 'selected' if course.status == 'archived' }}>Archived</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Settings -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">Advanced Settings</h2>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label for="prerequisites" class="block text-sm font-medium text-gray-700">Prerequisites</label>
                    <textarea name="prerequisites" id="prerequisites" rows="3"
                              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm"
                              placeholder="List any prerequisites for this course...">{{ course.prerequisites or '' }}</textarea>
                    <p class="mt-1 text-sm text-gray-500">What should students know before taking this course?</p>
                </div>

                <div>
                    <label for="objectives" class="block text-sm font-medium text-gray-700">Learning Objectives</label>
                    <textarea name="objectives" id="objectives" rows="3"
                              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm"
                              placeholder="What will students achieve after completing this course...">{{ course.objectives or '' }}</textarea>
                    <p class="mt-1 text-sm text-gray-500">Define clear learning outcomes for students</p>
                </div>
            </div>
        </div>

        <!-- Course Statistics (Read-only) -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">Course Statistics</h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600">{{ course.students_enrolled or 0 }}</div>
                        <div class="text-sm text-gray-500">Students Enrolled</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600">{{ course.modules_count or 0 }}</div>
                        <div class="text-sm text-gray-500">Modules</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-yellow-600">{{ "%.1f"|format(course.rating or 0) }}</div>
                        <div class="text-sm text-gray-500">Average Rating</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-600">
                            {{ course.created_at.strftime('%Y-%m-%d') if course.created_at else 'N/A' }}
                        </div>
                        <div class="text-sm text-gray-500">Created Date</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex items-center justify-between pt-6 border-t border-gray-200">
            <div class="flex space-x-3">
                <a href="{{ url_for('admin_courses') }}"
                   class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back to Courses
                </a>
                <button type="button" id="previewBtn"
                        class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    <i class="fas fa-eye mr-2"></i>
                    Preview Changes
                </button>
            </div>
            <div class="flex space-x-3">
                <button type="button" id="deleteBtn"
                        class="inline-flex items-center px-4 py-2 border border-red-300 shadow-sm text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50">
                    <i class="fas fa-trash mr-2"></i>
                    Delete Course
                </button>
                <button type="submit"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-blue-700">
                    <i class="fas fa-save mr-2"></i>
                    Update Course
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form validation
    const form = document.querySelector('form');
    const titleInput = document.getElementById('title');
    const descriptionInput = document.getElementById('description');
    const instructorSelect = document.getElementById('instructor_id');
    const levelSelect = document.getElementById('level');
    const deleteBtn = document.getElementById('deleteBtn');
    const previewBtn = document.getElementById('previewBtn');

    // Form validation on submit
    form.addEventListener('submit', function(e) {
        let isValid = true;
        const errors = [];

        // Validate required fields
        if (!titleInput.value.trim()) {
            errors.push('Course title is required');
            isValid = false;
        }

        if (!descriptionInput.value.trim()) {
            errors.push('Course description is required');
            isValid = false;
        }

        if (!instructorSelect.value) {
            errors.push('Please select an instructor');
            isValid = false;
        }

        if (!levelSelect.value) {
            errors.push('Please select a course level');
            isValid = false;
        }

        if (!isValid) {
            e.preventDefault();
            alert('Please fix the following errors:\n' + errors.join('\n'));
        }
    });

    // Delete course functionality
    deleteBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to delete this course? This action cannot be undone and will remove all associated modules and student progress.')) {
            // Send delete request
            fetch(`/admin/course/{{ course._id }}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.href = '{{ url_for("admin_courses") }}';
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('An error occurred while deleting the course');
                console.error('Error:', error);
            });
        }
    });

    // Preview functionality (basic implementation)
    previewBtn.addEventListener('click', function() {
        const courseData = {
            title: titleInput.value,
            description: descriptionInput.value,
            level: levelSelect.value,
            category: document.getElementById('category').value,
            duration: document.getElementById('duration').value,
            status: document.getElementById('status').value
        };

        // Create a simple preview modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
        modal.innerHTML = `
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Course Preview</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-medium text-gray-900">${courseData.title}</h4>
                            <p class="text-sm text-gray-500">${courseData.level} • ${courseData.category || 'General'}</p>
                        </div>
                        <div>
                            <p class="text-gray-700">${courseData.description}</p>
                        </div>
                        <div class="flex items-center space-x-4 text-sm text-gray-500">
                            <span>Duration: ${courseData.duration || 'Not specified'}</span>
                            <span>Status: ${courseData.status}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    });

    // Track unsaved changes
    let hasUnsavedChanges = false;
    const formElements = form.querySelectorAll('input, textarea, select');

    formElements.forEach(element => {
        element.addEventListener('change', function() {
            hasUnsavedChanges = true;
        });
    });

    // Warn about unsaved changes
    window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // Clear unsaved changes flag on form submit
    form.addEventListener('submit', function() {
        hasUnsavedChanges = false;
    });
});
</script>
{% endblock %}