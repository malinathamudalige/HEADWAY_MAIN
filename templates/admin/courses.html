<!-- templates/admin/courses.html -->
{% extends "base.html" %}

{% block title %}Course Management - Headway E-Learning{% endblock %}

{% block extra_css %}
<style>
.stat-card {
    transition: all 0.3s ease;
}
.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}
.course-row {
    transition: background-color 0.2s ease;
}
.course-row:hover {
    background-color: #f8fafc;
}
.status-published { color: #10b981; background-color: #d1fae5; }
.status-draft { color: #6b7280; background-color: #f3f4f6; }
.status-archived { color: #ef4444; background-color: #fee2e2; }

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

/* Action buttons styling */
.action-buttons {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    justify-content: flex-end;
    /* Allow the buttons to size naturally without truncating contents */
    min-width: 150px;
    white-space: nowrap;
    overflow: visible;
}

.action-btn {
    padding: 4px 8px;
    font-size: 11px;
    border-radius: 4px;
    border: 1px solid;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    white-space: nowrap;
}

.action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-view { color: #2563eb; background: #dbeafe; border-color: #93c5fd; }
.btn-view:hover { background: #bfdbfe; }

.btn-edit { color: #4b5563; background: #f3f4f6; border-color: #d1d5db; }
.btn-edit:hover { background: #e5e7eb; }

.btn-publish { color: #059669; background: #d1fae5; border-color: #a7f3d0; }
.btn-publish:hover { background: #bbf7d0; }

.btn-archive { color: #d97706; background: #fef3c7; border-color: #fcd34d; }
.btn-archive:hover { background: #fde68a; }

.btn-delete { color: #dc2626; background: #fee2e2; border-color: #fca5a5; }
.btn-delete:hover { background: #fecaca; }

/* Responsive table */
.table-responsive {
    overflow-x: auto;
    min-height: 400px;
}

.courses-table {
    min-width: 1200px;
    width: 100%;
}

/* Notification styling */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    max-width: 400px;
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.notification.success { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
.notification.error { background: #fee2e2; color: #991b1b; border: 1px solid #dc2626; }
.notification.warning { background: #fef3c7; color: #92400e; border: 1px solid #d97706; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8 flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Course Management</h1>
            <p class="mt-2 text-gray-600">Oversee all courses in the platform</p>
        </div>
        <div class="flex space-x-3">
            <a href="{{ url_for('admin_create_course') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-blue-700">
                <i class="fas fa-plus mr-2"></i>
                Create Course
            </a>
        </div>
    </div>

    <!-- Overview Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="stat-card bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-book text-2xl text-blue-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Total Courses</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ total_courses }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="stat-card bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle text-2xl text-green-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Published</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ published_courses }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="stat-card bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-edit text-2xl text-yellow-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Draft</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ draft_courses }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="stat-card bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-archive text-2xl text-red-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Archived</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ archived_courses }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="bg-white p-6 rounded-lg shadow mb-8">
        <form method="GET" action="{{ url_for('admin_courses') }}" class="space-y-4">
            <!-- Search Bar -->
            <div class="flex items-center space-x-4">
                <div class="flex-1 relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" name="search" value="{{ search }}"
                           placeholder="Search courses, instructors, or descriptions..."
                           class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-primary focus:border-primary">
                </div>
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-blue-700">
                    <i class="fas fa-search mr-2"></i>
                    Search
                </button>
            </div>

            <!-- Advanced Filters -->
            <div id="advancedFilters" style="display: none;" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Status</label>
                    <select name="status" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm">
                        <option value="">All Status</option>
                        <option value="published" {{ 'selected' if status_filter == 'published' }}>Published</option>
                        <option value="draft" {{ 'selected' if status_filter == 'draft' }}>Draft</option>
                        <option value="archived" {{ 'selected' if status_filter == 'archived' }}>Archived</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Level</label>
                    <select name="level" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm">
                        <option value="">All Levels</option>
                        <option value="Beginner" {{ 'selected' if level_filter == 'Beginner' }}>Beginner</option>
                        <option value="Intermediate" {{ 'selected' if level_filter == 'Intermediate' }}>Intermediate</option>
                        <option value="Advanced" {{ 'selected' if level_filter == 'Advanced' }}>Advanced</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Category</label>
                    <select name="category" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm">
                        <option value="">All Categories</option>
                        <option value="Grammar" {{ 'selected' if category_filter == 'Grammar' }}>Grammar</option>
                        <option value="Vocabulary" {{ 'selected' if category_filter == 'Vocabulary' }}>Vocabulary</option>
                        <option value="Speaking" {{ 'selected' if category_filter == 'Speaking' }}>Speaking</option>
                        <option value="Writing" {{ 'selected' if category_filter == 'Writing' }}>Writing</option>
                        <option value="Reading" {{ 'selected' if category_filter == 'Reading' }}>Reading</option>
                        <option value="Listening" {{ 'selected' if category_filter == 'Listening' }}>Listening</option>
                        <option value="Business English" {{ 'selected' if category_filter == 'Business English' }}>Business English</option>
                        <option value="Test Preparation" {{ 'selected' if category_filter == 'Test Preparation' }}>Test Preparation</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Instructor</label>
                    <select name="instructor" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm">
                        <option value="">All Instructors</option>
                        {% for instructor in instructor_options %}
                        <option value="{{ instructor.name.lower() }}" {{ 'selected' if instructor_filter == instructor.name.lower() }}>{{ instructor.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Sort By</label>
                    <select name="sort" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm">
                        <option value="created_desc" {{ 'selected' if sort_by == 'created_desc' }}>Newest First</option>
                        <option value="created_asc" {{ 'selected' if sort_by == 'created_asc' }}>Oldest First</option>
                        <option value="title_asc" {{ 'selected' if sort_by == 'title_asc' }}>Title A-Z</option>
                        <option value="students_desc" {{ 'selected' if sort_by == 'students_desc' }}>Most Students</option>
                        <option value="rating_desc" {{ 'selected' if sort_by == 'rating_desc' }}>Highest Rated</option>
                    </select>
                </div>
            </div>

            <!-- Filter Action Buttons -->
            <div id="filterActions" style="display: none;" class="flex items-center space-x-3">
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-blue-700">
                    Apply Filters
                </button>
                <a href="{{ url_for('admin_courses') }}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Clear Filters
                </a>
            </div>
        </form>
    </div>

    <!-- Bulk Actions Bar -->
    <div id="bulkActionsBar" style="display: none;" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <span id="selectedCount" class="text-sm font-medium text-blue-900">0 course(s) selected</span>
            </div>
            <div class="flex items-center space-x-3">
                <button onclick="bulkAction('publish')" class="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded text-green-700 bg-green-100 hover:bg-green-200">
                    <i class="fas fa-globe mr-1"></i>
                    Publish
                </button>
                <button onclick="bulkAction('unpublish')" class="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded text-yellow-700 bg-yellow-100 hover:bg-yellow-200">
                    <i class="fas fa-eye-slash mr-1"></i>
                    Unpublish
                </button>
                <button onclick="bulkAction('archive')" class="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded text-red-700 bg-red-100 hover:bg-red-200">
                    <i class="fas fa-archive mr-1"></i>
                    Archive
                </button>
                <button onclick="bulkAction('delete')" class="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded text-red-700 bg-red-100 hover:bg-red-200">
                    <i class="fas fa-trash mr-1"></i>
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Courses Table -->
    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
        <div class="table-responsive">
            <table class="courses-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <input type="checkbox" onchange="toggleAllCourses(this)" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Instructor</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Students</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modules</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rating</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Edit</th>
                    </tr>
                </thead>
                {# Define a set of placeholder images related to English and education for random assignment #}
                {% set placeholder_images = [
                    'https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                    'https://images.unsplash.com/photo-1518976024611-8a553f7eaa13?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                    'https://images.unsplash.com/photo-1503676260728-1c00da094a0b?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                    'https://images.unsplash.com/photo-1529070538774-1843cb3265df?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                    'https://images.unsplash.com/photo-1523580846011-d3a5bc25702b?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                    'https://images.unsplash.com/photo-1511512578047-dfb367046420?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80'
                ] %}
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for course in courses %}
                    <tr class="course-row">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" data-course-id="{{ course._id }}" onchange="toggleCourse('{{ course._id }}')" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    {# Use course.image if available; otherwise pick a random placeholder image #}
                                    <img class="h-10 w-10 rounded-full object-cover"
                                         src="{{ course.image if course.image else (placeholder_images | random) }}"
                                         alt="{{ course.title }}">
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">{{ course.title }}</div>
                                    <div class="text-sm text-gray-500">{{ course.level }} • {{ course.category or 'General' }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">{{ course.instructor_name }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium status-{{ course.status }}">
                                {{ course.status.title() }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ course.students_enrolled }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ course.modules_count }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <i class="fas fa-star text-yellow-400 text-sm mr-1"></i>
                                <span class="text-sm text-gray-900">{{ "%.1f"|format(course.rating or 0) }}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ course.created_at.strftime('%Y-%m-%d') if course.created_at else 'N/A' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="action-buttons">
                                <a href="{{ url_for('admin_edit_course', course_id=course._id) }}" class="action-btn btn-edit">
                                    <i class="fas fa-edit mr-1"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="px-6 py-12 text-center">
                            <div class="text-gray-500">
                                <i class="fas fa-book text-4xl mb-4"></i>
                                <p class="text-lg font-medium">No courses found</p>
                                <p class="text-sm">Try adjusting your search or filter criteria</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="display: none;" class="loading-overlay">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mr-4"></div>
                <span class="text-gray-700">Processing...</span>
            </div>
        </div>
    </div>
</div>

<!-- Course Details Modal -->
<div id="courseModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Course Details</h3>
                <button onclick="closeCourseModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="courseDetailsContent" class="space-y-4">
                <!-- Course details will be populated here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let selectedCourses = [];
let loading = false;
let filtersVisible = false;

// Initialize page on DOM load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, initializing...');

    // Test if functions exist
    if (typeof window.exportCourses === 'undefined') {
        console.log('Functions not loaded, defining them...');
        setupFunctions();
    }

    // Initialize page state
    updateSelectedCount();
    console.log('Page initialization complete');
});

function setupFunctions() {
    // Export CSV function
    window.exportCourses = function() {
        console.log('Export CSV clicked');
        showNotification('Starting export...', 'info');

        try {
            const params = new URLSearchParams(window.location.search);
            const exportUrl = '/admin/courses/export?' + params.toString();
            console.log('Export URL:', exportUrl);

            const link = document.createElement('a');
            link.href = exportUrl;
            link.download = 'courses_export_' + new Date().toISOString().split('T')[0] + '.csv';
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('Export started successfully!', 'success');
        } catch (error) {
            console.error('Export error:', error);
            showNotification('Export failed: ' + error.message, 'error');
        }
    };

    // Toggle filters function
    window.toggleFilters = function() {
        console.log('Toggle filters clicked');
        filtersVisible = !filtersVisible;

        const filtersDiv = document.getElementById('advancedFilters');
        const actionsDiv = document.getElementById('filterActions');
        const toggleText = document.getElementById('filterToggleText');

        if (filtersDiv && actionsDiv && toggleText) {
            if (filtersVisible) {
                filtersDiv.style.display = 'grid';
                actionsDiv.style.display = 'flex';
                toggleText.textContent = 'Hide Filters';
                console.log('Filters shown');
            } else {
                filtersDiv.style.display = 'none';
                actionsDiv.style.display = 'none';
                toggleText.textContent = 'Show Filters';
                console.log('Filters hidden');
            }
        } else {
            console.error('Filter elements not found');
        }
    };

    // View course function
    window.viewCourse = async function(courseId) {
        console.log('View course:', courseId);
        showLoading(true);

        try {
            const response = await fetch('/admin/course/' + courseId + '/view');
            if (!response.ok) throw new Error('Network response was not ok');

            const data = await response.json();
            showCourseModal(data);
        } catch (error) {
            console.error('View course error:', error);
            showNotification('Failed to load course details: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    };

    // Toggle course status function
    window.toggleCourseStatus = async function(courseId) {
        if (!confirm('Are you sure you want to change the status of this course?')) return;

        console.log('Toggle status for course:', courseId);
        showLoading(true);

        try {
            const response = await fetch('/admin/course/' + courseId + '/toggle-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) throw new Error('Network response was not ok');

            const data = await response.json();
            if (data.success) {
                showNotification(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.message, 'error');
            }
        } catch (error) {
            console.error('Toggle status error:', error);
            showNotification('Failed to update course status: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    };

    // Delete course function
    window.deleteCourse = async function(courseId, courseName) {
        if (!confirm('Are you sure you want to delete "' + courseName + '"? This action cannot be undone.')) return;

        console.log('Delete course:', courseId);
        showLoading(true);

        try {
            const response = await fetch('/admin/course/' + courseId + '/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) throw new Error('Network response was not ok');

            const data = await response.json();
            if (data.success) {
                showNotification(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.message, 'error');
            }
        } catch (error) {
            console.error('Delete course error:', error);
            showNotification('Failed to delete course: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    };

    // Toggle all courses function
    window.toggleAllCourses = function(checkbox) {
        const courseCheckboxes = document.querySelectorAll('tbody input[type="checkbox"][data-course-id]');
        selectedCourses = [];

        courseCheckboxes.forEach(cb => {
            cb.checked = checkbox.checked;
            if (checkbox.checked) {
                const courseId = cb.getAttribute('data-course-id');
                if (courseId) selectedCourses.push(courseId);
            }
        });

        updateSelectedCount();
    };

    // Toggle course function
    window.toggleCourse = function(courseId) {
        const index = selectedCourses.indexOf(courseId);
        if (index > -1) {
            selectedCourses.splice(index, 1);
        } else {
            selectedCourses.push(courseId);
        }
        updateSelectedCount();
    };

    // Bulk action function
    window.bulkAction = async function(action) {
        if (selectedCourses.length === 0) {
            showNotification('Please select at least one course', 'warning');
            return;
        }

        if (!confirm('Are you sure you want to ' + action + ' ' + selectedCourses.length + ' course(s)?')) return;

        showLoading(true);

        try {
            const formData = new FormData();
            formData.append('action', action);
            selectedCourses.forEach(id => formData.append('course_ids', id));

            const response = await fetch('/admin/courses/bulk-action', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('Network response was not ok');

            const data = await response.json();
            if (data.success) {
                showNotification(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.message, 'error');
            }
        } catch (error) {
            console.error('Bulk action error:', error);
            showNotification('Bulk action failed: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    };

    // Close modal function
    window.closeCourseModal = function() {
        const modal = document.getElementById('courseModal');
        if (modal) modal.style.display = 'none';
    };

    console.log('All functions defined successfully');
}

function showCourseModal(courseData) {
    const modal = document.getElementById('courseModal');
    const content = document.getElementById('courseDetailsContent');

    if (modal && content) {
        content.innerHTML = `
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Title</label>
                    <p class="mt-1 text-sm text-gray-900">${courseData.title || 'N/A'}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Status</label>
                    <span class="mt-1 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium status-${courseData.status}">
                        ${courseData.status ? courseData.status.charAt(0).toUpperCase() + courseData.status.slice(1) : 'N/A'}
                    </span>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Instructor</label>
                    <p class="mt-1 text-sm text-gray-900">${courseData.instructor_name || 'N/A'}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Level</label>
                    <p class="mt-1 text-sm text-gray-900">${courseData.level || 'N/A'}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Students Enrolled</label>
                    <p class="mt-1 text-sm text-gray-900">${courseData.students_enrolled || 0}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Modules</label>
                    <p class="mt-1 text-sm text-gray-900">${courseData.modules_count || 0}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Rating</label>
                    <p class="mt-1 text-sm text-gray-900">
                        <i class="fas fa-star text-yellow-400"></i>
                        <span>${courseData.rating ? courseData.rating.toFixed(1) : '0.0'}</span>
                    </p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Completion Rate</label>
                    <p class="mt-1 text-sm text-gray-900">${courseData.completion_rate ? courseData.completion_rate.toFixed(1) + '%' : '0.0%'}</p>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Description</label>
                <p class="mt-1 text-sm text-gray-900">${courseData.description || 'No description available'}</p>
            </div>
        `;

        modal.style.display = 'block';
    }
}

function updateSelectedCount() {
    const bulkBar = document.getElementById('bulkActionsBar');
    const countSpan = document.getElementById('selectedCount');

    if (bulkBar && countSpan) {
        if (selectedCourses.length > 0) {
            bulkBar.style.display = 'block';
            countSpan.textContent = selectedCourses.length + ' course(s) selected';
        } else {
            bulkBar.style.display = 'none';
        }
    }
}

function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.display = show ? 'flex' : 'none';
    }
}

function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existing = document.querySelectorAll('.notification');
    existing.forEach(notif => notif.remove());

    const notification = document.createElement('div');
    notification.className = 'notification ' + type;
    notification.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} mr-2"></i>
                <span>${message}</span>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;

    document.body.appendChild(notification);

    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('courseModal');
    if (event.target === modal) {
        closeCourseModal();
    }
}

// Initialize functions immediately
setupFunctions();
</script>
{% endblock %}