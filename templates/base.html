<!-- templates/base.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Headway E-Learning Platform{% endblock %}</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#8B5CF6',
                    }
                }
            }
        }
    </script>

    <!-- Critical CSS to prevent FOUC and ensure dropdown items are visible -->
    <style>
        [x-cloak] { display: none !important; }

        /* Debug CSS to ensure dropdown items are always visible */
        .fa-copy, .fa-trash, .fa-globe, .fa-pause {
            display: inline-block !important;
            visibility: visible !important;
        }

        /* Ensure dropdown menus have high z-index */
        [x-show] {
            z-index: 9999 !important;
        }
    </style>

    <!-- Alpine.js Pre-initialization Script -->
    <script>
        // Debug and compatibility script for Alpine.js
        console.log('üöÄ Starting Alpine.js debugging...');

        // Store original console methods
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;

        // Track Alpine initialization
        window.alpineInitialized = false;

        // Ensure Alpine doesn't conflict with existing code
        window.deferLoadingAlpine = function(callback) {
            window.addEventListener('alpine:init', callback);
        }

        // Monitor for dropdown issues
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM Content Loaded');

            // Set up mutation observer to catch DOM changes
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList') {
                        mutation.removedNodes.forEach((node) => {
                            if (node.nodeType === 1 && node.querySelector) {
                                // Check if dropdown menu items are being removed
                                const hasDropdownItems =
                                    node.querySelector('.fa-copy') ||
                                    node.querySelector('.fa-trash') ||
                                    node.querySelector('.fa-globe') ||
                                    node.querySelector('.fa-pause');

                                if (hasDropdownItems) {
                                    console.error('‚ö†Ô∏è CRITICAL: Dropdown menu items were removed from DOM!', {
                                        removedNode: node,
                                        timestamp: new Date().toISOString(),
                                        stackTrace: new Error().stack
                                    });
                                }
                            }
                        });
                    }

                    // Check for attribute changes that might hide elements
                    if (mutation.type === 'attributes') {
                        const target = mutation.target;
                        if (target.classList && (
                            target.classList.contains('fa-copy') ||
                            target.classList.contains('fa-trash') ||
                            target.classList.contains('fa-globe') ||
                            target.classList.contains('fa-pause')
                        )) {
                            console.warn('‚ö†Ô∏è Dropdown item attribute changed:', {
                                element: target,
                                attribute: mutation.attributeName,
                                oldValue: mutation.oldValue,
                                newValue: target.getAttribute(mutation.attributeName)
                            });
                        }
                    }
                });
            });

            // Start observing after a delay to catch the issue
            setTimeout(() => {
                console.log('üëÄ Starting DOM observation...');
                observer.observe(document.body, {
                    childList: true,
                    subtree: true,
                    attributes: true,
                    attributeOldValue: true
                });
            }, 100);
        });

        // Alpine.js initialization tracking
        document.addEventListener('alpine:init', () => {
            window.alpineInitialized = true;
            console.log('üéø Alpine.js initialized successfully!');

            // Log all Alpine components
            setTimeout(() => {
                const components = document.querySelectorAll('[x-data]');
                console.log(`üìä Found ${components.length} Alpine.js components:`);

                components.forEach((comp, index) => {
                    const xData = comp.getAttribute('x-data');
                    console.log(`  Component ${index + 1}:`, {
                        element: comp,
                        xData: xData,
                        hasDropdown: xData && xData.includes('dropdownOpen')
                    });
                });

                // Specifically check for course dropdown components
                const dropdowns = document.querySelectorAll('[x-data*="dropdownOpen"]');
                console.log(`üîΩ Found ${dropdowns.length} dropdown components`);

                dropdowns.forEach((dropdown, index) => {
                    console.log(`  Dropdown ${index + 1}:`, {
                        element: dropdown,
                        childElements: dropdown.querySelectorAll('button').length,
                        visible: window.getComputedStyle(dropdown).display !== 'none'
                    });
                });
            }, 500);
        });

        // Check Alpine.js loading status
        setTimeout(() => {
            if (typeof Alpine === 'undefined') {
                console.error('‚ùå Alpine.js failed to load!');
            } else {
                console.log('‚úÖ Alpine.js is available globally');
                console.log('Alpine version:', Alpine.version);
            }

            if (!window.alpineInitialized) {
                console.warn('‚ö†Ô∏è Alpine.js loaded but not initialized after 2 seconds');
            }
        }, 2000);

        // Protect dropdown functions from being overwritten
        window.addEventListener('load', function() {
            console.log('üèÅ Window fully loaded');

            // List of functions that might conflict
            const protectedFunctions = [
                'publishCourse',
                'unpublishCourse',
                'duplicateCourse',
                'deleteCourse'
            ];

            // Check if these functions exist globally
            protectedFunctions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    console.warn(`‚ö†Ô∏è Global function "${funcName}" detected - this might conflict with Alpine.js`);
                }
            });
        });

        // Error tracking
        window.addEventListener('error', function(e) {
            if (e.message && (
                e.message.includes('Alpine') ||
                e.message.includes('x-data') ||
                e.message.includes('dropdown')
            )) {
                console.error('üî¥ Alpine.js related error:', e);
            }
        });
    </script>

    <!-- Alpine.js -->
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

    <!-- Post-Alpine Debug Script -->
    <script>
        // This runs after Alpine.js should be loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Final check after everything should be loaded
            setTimeout(() => {
                console.log('üîç Final dropdown check:');

                // Check if dropdown buttons exist
                const dropdownButtons = document.querySelectorAll('button[onclick*="Course"]');
                console.log(`  Found ${dropdownButtons.length} course action buttons`);

                // Check for Alpine dropdowns
                const alpineDropdowns = document.querySelectorAll('[x-show="dropdownOpen"]');
                console.log(`  Found ${alpineDropdowns.length} Alpine dropdown menus`);

                // Check visibility of specific menu items
                const menuItems = {
                    'Duplicate': document.querySelectorAll('button:has(.fa-copy)').length,
                    'Delete': document.querySelectorAll('button:has(.fa-trash)').length,
                    'Publish': document.querySelectorAll('button:has(.fa-globe)').length,
                    'Unpublish': document.querySelectorAll('button:has(.fa-pause)').length
                };

                console.log('  Menu items found:', menuItems);

                // Check for any hidden elements
                document.querySelectorAll('[x-show="dropdownOpen"] button').forEach((btn, index) => {
                    const styles = window.getComputedStyle(btn);
                    if (styles.display === 'none' || styles.visibility === 'hidden') {
                        console.warn(`  ‚ö†Ô∏è Hidden button ${index}:`, btn);
                    }
                });
            }, 3000);
        });
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    {% if current_user %}
    <nav class="bg-white shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-graduation-cap text-primary mr-2"></i>
                            Headway E-Learning
                        </h1>
                    </div>
                    <div class="hidden md:ml-10 md:flex md:space-x-8">
                        <a href="{{ url_for('dashboard') }}" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Dashboard
                        </a>
                        {% if current_user.role == 'student' %}
                        <a href="{{ url_for('student_courses') }}" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            My Courses
                        </a>
                        {% elif current_user.role == 'educator' %}
                        <a href="{{ url_for('educator_courses') }}" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            My Courses
                        </a>
                        <a href="{{ url_for('educator_analytics') }}" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Analytics
                        </a>
                        {% elif current_user.role == 'admin' %}
                        <a href="{{ url_for('admin_users') }}" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Users
                        </a>
                        <a href="{{ url_for('admin_courses') }}" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Courses
                        </a>
                        {% endif %}
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" class="flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <img class="h-8 w-8 rounded-full" src="https://ui-avatars.com/api/?name={{ current_user.name }}&background=3B82F6&color=fff" alt="">
                            <span class="ml-2 text-gray-700">{{ current_user.name }}</span>
                            <i class="fas fa-chevron-down ml-1 text-gray-400"></i>
                        </button>
                        <div x-show="open"
                             @click.away="open = false"
                             x-cloak
                             x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="transform opacity-0 scale-95"
                             x-transition:enter-end="transform opacity-100 scale-100"
                             x-transition:leave="transition ease-in duration-75"
                             x-transition:leave-start="transform opacity-100 scale-100"
                             x-transition:leave-end="transform opacity-0 scale-95"
                             class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Profile</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Settings</a>
                            <a href="{{ url_for('logout') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign out</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    {% endif %}

    <!-- FLASH MESSAGES -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
        {% for category, message in messages %}
          <div
            class="flash-message rounded-md p-4 mb-4 flex items-center justify-between
                   {% if category == 'error' %}
                     bg-red-50 border border-red-200 text-red-800
                   {% elif category == 'success' %}
                     bg-green-50 border border-green-200 text-green-800
                   {% elif category == 'warning' %}
                     bg-yellow-50 border border-yellow-200 text-yellow-800
                   {% else %}
                     bg-blue-50 border border-blue-200 text-blue-800
                   {% endif %}"
            role="alert"
          >
            <span class="flex items-center space-x-2">
              {% if category == 'error' %}
                <i class="fas fa-exclamation-circle text-red-400"></i>
              {% elif category == 'success' %}
                <i class="fas fa-check-circle text-green-400"></i>
              {% elif category == 'warning' %}
                <i class="fas fa-exclamation-triangle text-yellow-400"></i>
              {% else %}
                <i class="fas fa-info-circle text-blue-400"></i>
              {% endif %}
              <span class="text-sm">{{ message }}</span>
            </span>
            <button
              type="button"
              class="close-button ml-4 text-current opacity-70 hover:opacity-100 transition-opacity"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

    <!-- Main Content -->
    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-12">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="text-center text-gray-500 text-sm">
                <p>&copy; 2025 Headway School of Languages. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Modified Flash Message Script with debugging -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      const flashMessages = document.querySelectorAll('.flash-message');
      flashMessages.forEach(function(msg, idx) {
        // staggered auto-hide
        setTimeout(function() {
          msg.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
          msg.style.opacity = '0';
          msg.style.transform = 'translateY(-10px)';
          setTimeout(() => msg.remove(), 500);
        }, 5000 + idx * 200);

        // manual close
        const btn = msg.querySelector('.close-button');
        if (btn) {
          btn.addEventListener('click', () => {
            msg.remove();
          });
        }
      });
    });
  </script>

    <!-- Load custom app.js if it exists (can be commented out for testing) -->
    {% block extra_js %}
    <!-- Uncomment the line below if you have a custom app.js file -->
     <script src="{{ url_for('static', filename='js/app.js') }}" defer></script>
    {% endblock %}

    <!-- Final debugging check -->
    <script>
        window.addEventListener('load', function() {
            console.log('='.repeat(60));
            console.log('üèÅ FINAL DEBUGGING SUMMARY:');
            console.log('='.repeat(60));
            console.log('Alpine.js loaded:', typeof Alpine !== 'undefined');
            console.log('Alpine initialized:', window.alpineInitialized);
            console.log('Total Alpine components:', document.querySelectorAll('[x-data]').length);
            console.log('Dropdown components:', document.querySelectorAll('[x-data*="dropdownOpen"]').length);
            console.log('='.repeat(60));
            console.log('üí° Check the console above for any errors or warnings');
            console.log('üí° If dropdown items disappear, look for "CRITICAL" messages');
            console.log('='.repeat(60));
        });
    </script>
</body>
</html>